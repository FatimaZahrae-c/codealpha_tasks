from scapy.all import sniff, Ether, IP, TCP, UDP , DNS, DNSQR, DNSRR
from datetime import datetime

def analyze_packet(packet):
    print(f"[{datetime.now().strftime('%H:%M:%S')}] Packet Captured: {packet.summary()}")
    
    # Ethernet Layer
    if packet.haslayer(Ether):
        eth = packet[Ether]
        print("ğŸŸ¡ Ethernet Layer:")
        print(f"   â†ª Source MAC      : {eth.src}")
        print(f"   â†ª Destination MAC : {eth.dst}")
        print(f"   â†ª EtherType       : {hex(eth.type)}")

    # IP Layer
    if packet.haslayer(IP):
        ip = packet[IP]
        print("ğŸ”µ IP Layer:")
        print(f"   â†ª Source IP       : {ip.src}")
        print(f"   â†ª Destination IP  : {ip.dst}")
        print(f"   â†ª Version         : {ip.version}")
        print(f"   â†ª Header Length   : {ip.ihl * 4} bytes")
        print(f"   â†ª Total Length    : {ip.len} bytes")
        print(f"   â†ª TTL             : {ip.ttl}")
        print(f"   â†ª Protocol        : {ip.proto}")

    # TCP Layer
    if packet.haslayer(TCP):
        tcp = packet[TCP]
        print("ğŸŸ¢ TCP Layer:")
        print(f"   â†ª Source Port     : {tcp.sport}")
        print(f"   â†ª Destination Port: {tcp.dport}")
        print(f"   â†ª Sequence Number : {tcp.seq}")
        print(f"   â†ª ACK Number      : {tcp.ack}")
        print(f"   â†ª Flags           : {tcp.flags}")
        print(f"   â†ª Window Size     : {tcp.window}")

    # UDP Layer
    if packet.haslayer(UDP):
        udp = packet[UDP]
        print("ğŸŸ£ UDP Layer:")
        print(f"   â†ª Source Port     : {udp.sport}")
        print(f"   â†ª Destination Port: {udp.dport}")
        print(f"   â†ª Length          : {udp.len} bytes")

     # DNS Layer
    if packet.haslayer(DNS):
        dns = packet[DNS]
        print("ğŸ”µ DNS Layer:")
        if dns.qr == 0 and dns.opcode == 0: 
            query = packet[DNSQR].qname.decode()
            print(f"   â†ª DNS Query        : {query}")
        elif dns.qr == 1:  # Response
            print("   â†ª DNS Response:")
            for i in range(dns.ancount):
                rr = dns.an[i]
                print(f"     â†ª {rr.rrname.decode()} â†’ {rr.rdata}")

    

interface = None
packet_count = 5    
print(f"\nğŸ” Starting sniffer on interface: {interface or 'default'}")
print(f"ğŸ“¦ Capturing {packet_count} packets...\n")
sniff(iface=interface, prn=analyze_packet, count=packet_count, store=False, filter="ip")


